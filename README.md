# carrier

![Build Status](https://github.com/rsvihladremio/carrier/actions/workflows/python-unit-tests.yaml/badge.svg)

carrier script that runs a script on every node you want, be it on kubernetes or over ssh. 

## Goal

* Run a script against N number of nodes
* Collect the output of the script and log each nodes output to a debug.log
* Collect all files generated by the script, tar.gz the files and transport them back to the client
* end up with one big tar.gz that contains the results of collection from all nodes.

## SSH based carrier usage

Just need to have ssh and scp installed. Can use key based auth or a username and password.
Your script should generate any output files in it's current directory or in a subdirectory of it's current directory.

```bash

usage: carrier.py [-h] [--hosts HOSTS] [--hosts-file HOSTS_FILE] [--username USERNAME] [--use-key]
                  [--shell {bash,zsh,sh}] [--script-args ...]
                  script

Run a script on multiple hosts and collect output.

positional arguments:
  script                Path to the script file to run on hosts.

options:
  -h, --help            show this help message and exit
  --hosts HOSTS         Comma-separated list of hosts (e.g., 'host1,host2').
  --hosts-file HOSTS_FILE
                        File containing a list of hosts, one per line.
  --username USERNAME   Username for SSH authentication.
  --use-key             Use key-based authentication (default: False).
  --shell {bash,zsh,sh}
                        Shell to use for running the script (default: bash).
  --script-args ...     Arguments for the script
```

## Kubernetes based Carrier usage

Just need to have kubectl installed and the default context setup to be the cluster you want to collect against.
Your script should generate any output files in it's current directory or in a subdirectory of it's current directory. The files generated on the pod will be removed after.

```
usage: carrier_k8s.py [-h] [--script-args ...] [--namespace NAMESPACE] [--labels LABELS]
                      [--shell {bash,zsh,sh}]
                      script

Run a script on multiple pods and collect output.

positional arguments:
  script                Path to the script file to run on pods.

options:
  -h, --help            show this help message and exit
  --script-args ...     Arguments for the script
  --namespace NAMESPACE
                        Kubernetes namespace to use.
  --labels LABELS       Comma-separated list of label selectors (e.g., 'app=myapp,env=prod').
  --shell {bash,zsh,sh}
                        Shell to use for running the script (default: bash).
```

### Examples

If we want to find which labels are on which pods you can run `get pods` with the `--show-labels` flag. We can see that `role=dremio-cluster-pod` is common to the coordinator and executor, but `app=dremio-coordinator` is only on the coordinator

```kubectl get pods --show-labels
NAME                READY   STATUS    RESTARTS   AGE     LABELS
dremio-executor-0   1/1     Running   0          7m10s   app=dremio-executor,controller-revision-hash=dremio-executor-548dbb9fd8,role=dremio-cluster-pod,statefulset.kubernetes.io/pod-name=dremio-executor-0
dremio-master-0     2/2     Running   0          7m10s   app=dremio-coordinator,controller-revision-hash=dremio-master-975b755b5,role=dremio-cluster-pod,statefulset.kubernetes.io/pod-name=dremio-master-0
zk-0                1/1     Running   0          7m10s   app=zk,controller-revision-hash=zk-66557b548b,statefulset.kubernetes.io/pod-name=zk-0
zk-1                1/1     Running   0          7m10s   app=zk,controller-revision-hash=zk-66557b548b,statefulset.kubernetes.io/pod-name=zk-1
zk-2                1/1     Running   0          7m10s   app=zk,controller-revision-hash=zk-66557b548b,statefulset.kubernetes.io/pod-name=zk-2
```

If we want to run a collection from all pods

```
python3 ./carrier_k8s.py --namespace default --labels role=dremio-cluster-pod --shell bash scripts/collect-metrics.sh
```

Typical output example

```
progress: creating tmp dir /tmp/dremio-executor-0_tmp on dremio-executor-0
progress: creating tmp dir /tmp/dremio-master-0_tmp on dremio-master-0
progress: copying script scripts/collect-metrics.sh to dremio-executor-0
progress: copying script scripts/collect-metrics.sh to dremio-master-0
progress: running script on dremio-executor-0
progress: running script on dremio-master-0
progress: archiving files for dremio-executor-0
progress: archiving files for dremio-master-0
progress: copying back files from dremio-executor-0
progress: copying back files from dremio-master-0
All done! The final archive is output.tar.gz
```

